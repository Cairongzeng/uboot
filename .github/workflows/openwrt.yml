name: OpenWrt Builder

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: '源码仓库'
        required: true
        default: 'openwrt/openwrt'
        type: string
      source_branch:
        description: '源码分支'
        required: true
        default: 'main'
        type: string
      custom_feeds:
        description: '自定义软件源（每行一个）'
        required: false
        default: ''
        type: string
      target:
        description: '目标架构'
        required: true
        default: 'airoha'
        type: string
      subtarget:
        description: '芯片系列'
        required: true
        default: 'an7581'
        type: string
      profile:
        description: '设备配置'
        required: true
        default: 'xg-040g-md'
        type: string
      packages:
        description: '定制软件包（逗号分隔）'
        required: false
        default: 'luci-theme-argon,luci-app-dufs,tailscale,luci-app-vlmcsd,luci-app-adblock'
        type: string
      clean_build:
        description: '全新构建（清理缓存）'
        required: false
        default: false
        type: boolean

jobs:
  build-firmware:
    name: 构建 ${{ github.event.inputs.profile }}
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: write

    steps:
    - name: 初始化环境
      run: |
        echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "TARGET=${{ github.event.inputs.target }}" >> $GITHUB_ENV
        echo "SUBTARGET=${{ github.event.inputs.subtarget }}" >> $GITHUB_ENV
        echo "PROFILE=${{ github.event.inputs.profile }}" >> $GITHUB_ENV

    - name: 检出源码
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.source_repo }}
        ref: ${{ github.event.inputs.source_branch }}
        submodules: recursive
        fetch-depth: 1

    - name: 清理环境
      if: github.event.inputs.clean_build == 'true'
      run: |
        git clean -fdx
        git reset --hard
        rm -rf dl/* .ccache/*

    - name: 添加自定义软件源
      if: github.event.inputs.custom_feeds != ''
      run: |
        echo "${{ github.event.inputs.custom_feeds }}" | sed 's/\\n/\n/g' >> feeds.conf.default

    - name: 缓存编译依赖
      if: github.event.inputs.clean_build == 'false'
      uses: actions/cache@v4
      with:
        path: |
          dl
          .ccache
        key: openwrt-${{ github.event.inputs.source_repo }}-${{ github.event.inputs.source_branch }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ env.PROFILE }}-${{ hashFiles('feeds.conf.default') }}-pkgs-${{ github.event.inputs.packages }}
        restore-keys: |
          openwrt-${{ github.event.inputs.source_repo }}-${{ github.event.inputs.source_branch }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ env.PROFILE }}-${{ hashFiles('feeds.conf.default') }}-
          openwrt-${{ github.event.inputs.source_repo }}-${{ github.event.inputs.source_branch }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ env.PROFILE }}-
          openwrt-${{ github.event.inputs.source_repo }}-${{ github.event.inputs.source_branch }}-
          openwrt-

    - name: 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git rsync unzip file wget cpio aria2 jq libncurses5-dev libssl-dev zlib1g-dev libelf-dev libev-dev libpam0g-dev libtirpc-dev liblzma-dev libsnmp-dev libcap-dev libattr1-dev libaudit-dev libaio-dev liburing-dev libjson-c-dev python3-dev python3-setuptools python3-pip python3-venv swig patch texinfo time pkg-config autoconf automake libtool ccache libmosquitto-dev libsqlite3-dev libcurl4-openssl-dev libmnl-dev libnetfilter-conntrack-dev libnetfilter-queue-dev libselinux1-dev gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi device-tree-compiler xxd gperf libglib2.0-dev libdbus-1-dev libgmp-dev libmpc-dev libmpfr-dev

    - name: 配置ccache
      run: |
        mkdir -p .ccache
        echo "max_size = 10G" > .ccache/ccache.conf
        echo "cache_dir = $(pwd)/.ccache" >> .ccache/ccache.conf
        echo "compression = true" >> .ccache/ccache.conf
        echo "compression_level = 1" >> .ccache/ccache.conf

    - name: 更新feeds
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 生成配置
      run: |
        set -e
        > .config
        echo "CONFIG_TARGET_${TARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}=y" >> .config
        echo "CONFIG_TARGET_${TARGET}_${SUBTARGET}_DEVICE_${PROFILE}=y" >> .config
        
        if [ -n "${{ github.event.inputs.packages }}" ]; then
          echo "${{ github.event.inputs.packages }}" | tr ',' '\n' | while read -r pkg; do
            pkg=$(echo "$pkg" | xargs)
            [ -z "$pkg" ] && continue
            
            if ./scripts/feeds install "$pkg"; then
              pkg_upper=$(echo "$pkg" | tr 'a-z-' 'A-Z_')
              echo "CONFIG_PACKAGE_${pkg_upper}=y" >> .config
            fi
          done
        fi
        
        make defconfig
        cp .config .config.full

    - name: 下载源码
      run: |
        set -e
        attempt=1
        max_attempts=3
        while [ $attempt -le $max_attempts ]; do
          echo "下载尝试 $attempt/$max_attempts..."
          if make download -j$(nproc); then
            echo "下载成功"
            break
          else
            echo "下载失败，清理损坏的文件..."
            find dl -size 0 -delete
            find . -name "*.download" -delete
            if [ $attempt -eq $max_attempts ]; then
              echo "达到最大重试次数，构建失败"
              exit 1
            fi
            sleep 10
            attempt=$((attempt + 1))
          fi
        done

    - name: 编译固件
      run: |
        set -e
        echo "开始编译..."
        export CCACHE_DIR=$(pwd)/.ccache
        export CCACHE_MAXSIZE=10G
        export CCACHE_COMPRESS=1
        ccache -s
        make -j$(nproc) V=s
        echo "编译完成"

    - name: 上传固件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PROFILE }}-${{ env.BUILD_DATE }}
        path: bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}
        retention-days: 7

    - name: 上传日志（失败时）
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ env.PROFILE }}-${{ env.BUILD_DATE }}
        path: |
          .config
          .config.full
          feeds.conf.default
        retention-days: 7

    - name: 显示ccache统计
      if: always()
      run: |
        export CCACHE_DIR=$(pwd)/.ccache
        ccache -s

    - name: 创建发布
      if: success()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.PROFILE }}-${{ env.BUILD_DATE }}
        name: ${{ env.PROFILE }} ${{ env.BUILD_DATE }}
        body: |
          设备: ${{ env.PROFILE }}
          架构: ${{ env.TARGET }}/${{ env.SUBTARGET }}
          
          定制软件: ${{ github.event.inputs.packages }}
        files: bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*
        draft: false
        prerelease: false
